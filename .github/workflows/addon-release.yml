name: Addon Release

env:
  PROGRAM_NAME: "zbProgram"

on:
  workflow_dispatch:
    inputs:
      addon_id:
        description: "插件 ID"
        required: true
      version:
        description: "版本号"
        required: false
        default: ""
      changelog:
        description: "更新日志"
        required: false
        default: ""

jobs:
  deploy-addon:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: 显示发布信息
        shell: pwsh
        run: |
          Write-Host "=== 插件发布信息 ==="
          Write-Host "插件 ID : ${{ github.event.inputs.addon_id }}"
          Write-Host "版本号  : ${{ github.event.inputs.version }}"
          Write-Host "更新日志: ${{ github.event.inputs.changelog }}"
          Write-Host "======================"

      - name: 处理插件发布
        shell: pwsh
        env:
          ADDON_ID: ${{ github.event.inputs.addon_id }}
          VERSION: ${{ github.event.inputs.version }}
          CHANGELOG: ${{ github.event.inputs.changelog }}
          DUFS_URL: ${{ secrets.DUFS_URL }}
          DUFS_USER: ${{ secrets.DUFS_USER }}
          DUFS_PASSWORD: ${{ secrets.DUFS_PASSWORD }}
        run: |
          Add-Type -AssemblyName System.IO.Compression.FileSystem

          # 插件目录
          $addonPath = Join-Path $Env:GITHUB_WORKSPACE "addon" $Env:ADDON_ID
          if (-not (Test-Path $addonPath)) {
            Write-Error "插件目录不存在: $addonPath"
            exit 1
          }

          # 读取 addon.json
          $addonJsonPath = Join-Path $addonPath "addon.json"
          if (-not (Test-Path $addonJsonPath)) {
            Write-Error "插件配置文件不存在: $addonJsonPath"
            exit 1
          }

          $addonConfig = Get-Content -Raw $addonJsonPath | ConvertFrom-Json

          # 版本处理
          if ($Env:VERSION -and $Env:VERSION -ne '') {
            if ($addonConfig.version -ne $Env:VERSION) {
              $addonConfig.version = $Env:VERSION
              $addonConfig.version_code = [int]$addonConfig.version_code + 1

              if (-not $addonConfig.history) {
                $addonConfig.history = @{}
              }

              if (-not $addonConfig.history.PSObject.Properties[$Env:VERSION]) {
                $addonConfig.history | Add-Member -NotePropertyName $Env:VERSION -NotePropertyValue @{
                  time = (Get-Date -Format "yyyy年M月d日")
                  log  = if ($Env:CHANGELOG) { $Env:CHANGELOG } else { "版本更新" }
                }
              }
            }
          }

          # 写回 addon.json（版本 / 历史）
          $addonConfig | ConvertTo-Json -Depth 10 | Set-Content $addonJsonPath -Encoding UTF8

          # DUFS 校验
          if (-not $Env:DUFS_URL -or -not $Env:DUFS_USER -or -not $Env:DUFS_PASSWORD) {
            Write-Host "DUFS 未配置，跳过上传"
            exit 0
          }

          $dufsBase   = $Env:DUFS_URL.TrimEnd('/')
          $directBase = "https://drive.ianzb.cn"
          $addonDufs  = "$dufsBase/code/${{ env.PROGRAM_NAME }}/addon/$($addonConfig.id)"

          # 直链地址
          $zipLink  = "$directBase/code/${{ env.PROGRAM_NAME }}/addon/$($addonConfig.id)/$($addonConfig.id).zip"
          $jsonLink = "$directBase/code/${{ env.PROGRAM_NAME }}/addon/$($addonConfig.id)/addon.json"

          if ($addonConfig.icon) {
            $iconName = [System.IO.Path]::GetFileName($addonConfig.icon)
            $addonConfig.icon = "$directBase/code/${{ env.PROGRAM_NAME }}/addon/$($addonConfig.id)/$iconName"
          }

          $addonConfig.file = $zipLink
          $addonConfig.url  = $jsonLink

          # 再次写回（直链）
          $addonConfig | ConvertTo-Json -Depth 10 | Set-Content $addonJsonPath -Encoding UTF8

          # 创建 ZIP
          $zipPath = Join-Path $Env:GITHUB_WORKSPACE "$($addonConfig.id).zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          [System.IO.Compression.ZipFile]::CreateFromDirectory($addonPath, $zipPath)

          # 上传 ZIP
          curl --fail --silent --show-error `
            --user "$($Env:DUFS_USER):$($Env:DUFS_PASSWORD)" `
            -T "$zipPath" "$addonDufs/$($addonConfig.id).zip"

          # 上传 icon
          if ($addonConfig.icon) {
            $iconName = [System.IO.Path]::GetFileName($addonConfig.icon)
            $iconPath = Join-Path $addonPath $iconName
            if (Test-Path $iconPath) {
              curl --fail --silent --show-error `
                --user "$($Env:DUFS_USER):$($Env:DUFS_PASSWORD)" `
                -T "$iconPath" "$addonDufs/$iconName"
            }
          }

          # 上传 addon.json
          curl --fail --silent --show-error `
            --user "$($Env:DUFS_USER):$($Env:DUFS_PASSWORD)" `
            -T "$addonJsonPath" "$addonDufs/addon.json"

          # 更新主索引
          $mainIndexPath = Join-Path $Env:GITHUB_WORKSPACE "addon" "addon.json"
          $mainIndex = Get-Content -Raw $mainIndexPath | ConvertFrom-Json
          $mainIndex.$($addonConfig.id) = $jsonLink
          $mainIndex | ConvertTo-Json | Set-Content $mainIndexPath -Encoding UTF8

          curl --fail --silent --show-error `
            --user "$($Env:DUFS_USER):$($Env:DUFS_PASSWORD)" `
            -T "$mainIndexPath" "$dufsBase/code/${{ env.PROGRAM_NAME }}/addon/addon.json"

          Write-Host "插件发布完成"
          Write-Host "插件地址: $jsonLink"
          Write-Host "ZIP 文件: $zipLink"

      - name: 提交更改
        shell: pwsh
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -u
          if (-not (git diff --cached --quiet)) {
            git stash
            git pull --rebase origin main
            git stash pop
            git add -u
            git commit -m "Update addon ${{ github.event.inputs.addon_id }} to ${{ github.event.inputs.version }} [ci skip]"
            git push origin main
          } else {
            Write-Host "无变更需要提交"
          }
