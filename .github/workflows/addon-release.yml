name: Addon Release

on:
  workflow_dispatch:
    inputs:
      addon_id:
        description: '插件ID (如: appstore, filemanager, seewokit)'
        required: true
      version:
        description: '版本号 (可选，留空则不更新版本)'
        required: false
        default: ''
      changelog:
        description: '更新日志 (可选)'
        required: false
        default: ''

jobs:
  deploy-addon:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: 显示发布信息
        shell: pwsh
        run: |
          Write-Host "=== 插件发布信息 ==="
          Write-Host "插件ID: ${{ github.event.inputs.addon_id }}"
          Write-Host "版本号: ${{ github.event.inputs.version }}"
          Write-Host "更新日志: ${{ github.event.inputs.changelog }}"
          Write-Host "===================="

      - name: 处理插件发布
        env:
          ADDON_ID: ${{ github.event.inputs.addon_id }}
          VERSION: ${{ github.event.inputs.version }}
          CHANGELOG: ${{ github.event.inputs.changelog }}
          DUFS_URL: ${{ secrets.DUFS_URL }}
          DUFS_USER: ${{ secrets.DUFS_USER }}
          DUFS_PASSWORD: ${{ secrets.DUFS_PASSWORD }}
        shell: pwsh
        run: |
          # 导入必要的模块
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          
          # 检查插件目录是否存在
          $addonPath = Join-Path $Env:GITHUB_WORKSPACE "addon" $Env:ADDON_ID
          if (-not (Test-Path $addonPath)) {
            Write-Error "插件目录不存在: $addonPath"
            exit 1
          }
          
          # 读取插件配置文件
          $addonJsonPath = Join-Path $addonPath "addon.json"
          if (-not (Test-Path $addonJsonPath)) {
            Write-Error "插件配置文件不存在: $addonJsonPath"
            exit 1
          }
          
          $addonConfig = Get-Content $addonJsonPath -Raw | ConvertFrom-Json
          
          # 处理版本号更新
          $shouldUpdateVersion = $false
          if ($Env:VERSION -and $Env:VERSION -ne '') {
            if ($addonConfig.version -ne $Env:VERSION) {
              # 版本号变化，版本序数+1
              $addonConfig.version = $Env:VERSION
              $addonConfig.version_code = [int]$addonConfig.version_code + 1
              $shouldUpdateVersion = $true
          
              # 检查是否需要添加历史记录
              if (-not $addonConfig.history.PSObject.Properties[$Env:VERSION]) {
                $currentTime = Get-Date -Format "yyyy年M月d日"
                $logText = if ($Env:CHANGELOG -and $Env:CHANGELOG -ne '') { $Env:CHANGELOG } else { "版本更新" }
          
                if (-not $addonConfig.history) {
                  $addonConfig.history = @{}
                }
                $addonConfig.history | Add-Member -NotePropertyName $Env:VERSION -NotePropertyValue @{
                  time = $currentTime
                  log = $logText
                }
              }
            }
            # 版本号相同，版本序数不变
          }
          
          # 更新插件配置文件（包含版本信息和历史记录）
          $addonConfig | ConvertTo-Json -Depth 10 | Set-Content $addonJsonPath -Encoding UTF8
          Write-Host "已更新插件配置文件，包含版本信息和历史记录"
          
          # 创建ZIP压缩包（在配置文件更新后）
          $zipFileName = "$($addonConfig.id).zip"
          $zipPath = Join-Path $Env:GITHUB_WORKSPACE $zipFileName
          
          if (Test-Path $zipPath) {
            Remove-Item $zipPath
          }
          
          Write-Host "创建压缩包: $zipFileName"
          [System.IO.Compression.ZipFile]::CreateFromDirectory($addonPath, $zipPath)
          
          # 上传到DUFS服务器
          if (-not $Env:DUFS_URL -or -not $Env:DUFS_USER -or -not $Env:DUFS_PASSWORD) {
            Write-Host 'DUFS配置未设置，跳过上传'
            exit 0
          }
          
          $dufsBase = $Env:DUFS_URL.TrimEnd('/')
          $addonDufsPath = "$dufsBase/code/program/addon/$($addonConfig.id)"
          
          # 上传插件文件
          Write-Host "上传插件文件到DUFS服务器..."
          
          # 上传ZIP文件
          $zipDufsPath = "$addonDufsPath/$zipFileName"
          curl --fail --show-error --silent --user "$($Env:DUFS_USER):$($Env:DUFS_PASSWORD)" -T "$zipPath" "$zipDufsPath"
          
          # 上传图标文件（如果存在）
          $iconFileName = [System.IO.Path]::GetFileName($addonConfig.icon)
          if ($iconFileName -and $iconFileName -ne '') {
            $iconPath = Join-Path $addonPath $iconFileName
            if (Test-Path $iconPath) {
              $iconDufsPath = "$addonDufsPath/$iconFileName"
              curl --fail --show-error --silent --user "$($Env:DUFS_USER):$($Env:DUFS_PASSWORD)" -T "$iconPath" "$iconDufsPath"
            }
          }
          
          # 将DUFS URL转换为直链URL
          $directLinkBase = "$($Env:DUFS_URL)"
          $zipDirectLink = $zipDufsPath -replace [regex]::Escape($dufsBase), $directLinkBase
          $iconDirectLink = if ($iconFileName -and $iconFileName -ne '') {
            $iconDufsPath -replace [regex]::Escape($dufsBase), $directLinkBase
          } else {
            $null
          }
          
          # 更新插件配置中的URL为直链
          $addonConfig.file = $zipDirectLink
          if ($iconDirectLink) {
            $addonConfig.icon = $iconDirectLink
          }
          $addonConfig.url = "$directLinkBase/code/program/addon/$($addonConfig.id)/addon.json"
          
          # 更新插件配置文件
          $addonConfig | ConvertTo-Json -Depth 10 | Set-Content $addonJsonPath -Encoding UTF8
          Write-Host "已更新插件配置文件，URL已转换为直链格式"
          
          # 上传JSON配置文件（使用直链URL的版本）
          $jsonDufsPath = "$addonDufsPath/addon.json"
          curl --fail --show-error --silent --user "$($Env:DUFS_USER):$($Env:DUFS_PASSWORD)" -T "$addonJsonPath" "$jsonDufsPath"
          
          # 更新主索引文件
          $mainIndexPath = Join-Path $Env:GITHUB_WORKSPACE "addon" "addon.json"
          $mainIndex = Get-Content $mainIndexPath -Raw | ConvertFrom-Json
          
          $addonDirectUrl = "$directLinkBase/code/program/addon/$($addonConfig.id)/addon.json"
          if ($mainIndex.PSObject.Properties[$addonConfig.id]) {
            $mainIndex.$($addonConfig.id) = $addonDirectUrl
          } else {
            $mainIndex | Add-Member -NotePropertyName $addonConfig.id -NotePropertyValue $addonDirectUrl
          }
          
          $mainIndex | ConvertTo-Json | Set-Content $mainIndexPath -Encoding UTF8
          
          # 上传主索引文件
          $mainIndexDufsPath = "$dufsBase/code/program/addon/addon.json"
          curl --fail --show-error --silent --user "$($Env:DUFS_USER):$($Env:DUFS_PASSWORD)" -T "$mainIndexPath" "$mainIndexDufsPath"
          
          Write-Host "插件发布完成!"
          Write-Host "插件URL: $addonDirectUrl"
          Write-Host "ZIP文件: $zipDirectLink"

      - name: 提交更改
        if: success()
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -u
          if (-not (git diff --cached --quiet)) {
            # Stash any uncommitted changes first
            git stash
            # Pull remote changes with rebase
            git pull --rebase origin main
            # Restore stashed changes
            git stash pop
            # Add all modified files (including those restored from stash)
            git add -u
            git commit -m "Update addon ${{ github.event.inputs.addon_id }} to version ${{ github.event.inputs.version }} [ci skip]"
            git push origin main
          } else {
            Write-Host "No changes to commit"
          }
